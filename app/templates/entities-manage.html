<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Entity Management - Life Admin System</title>
    <link rel="stylesheet" href="/static/styles/enhancements.css" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #F5F5F7;
        color: #1D1D1F;
        line-height: 1.5;
      }

      .app-container {
        display: flex;
        height: 100vh;
      }

      .sidebar {
        width: 240px;
        background: #FFFFFF;
        border-right: 1px solid #D2D2D7;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 24px 20px;
        border-bottom: 1px solid #D2D2D7;
      }

      .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #1D1D1F;
      }

      .sidebar-nav {
        flex: 1;
        padding: 16px 0;
        overflow-y: auto;
      }

      .nav-section {
        margin-bottom: 24px;
      }

      .nav-section-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #86868B;
        padding: 8px 20px;
        letter-spacing: 0.5px;
      }

      .nav-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 20px;
        color: #1D1D1F;
        text-decoration: none;
        font-size: 14px;
        transition: background 0.15s;
      }

      .nav-item:hover {
        background: #F5F5F7;
      }

      .nav-item.active {
        background: #E8E8ED;
        font-weight: 500;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .top-bar {
        background: #FFFFFF;
        border-bottom: 1px solid #D2D2D7;
        padding: 16px 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
      }

      .add-entity-btn {
        padding: 8px 16px;
        background: #0071E3;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
      }

      .add-entity-btn:hover {
        background: #0077ED;
      }

      .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
      }

      .intro-text {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #D2D2D7;
        margin-bottom: 32px;
      }

      .intro-text h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .intro-text p {
        font-size: 14px;
        color: #515154;
        line-height: 1.6;
      }

      .entity-type-section {
        margin-bottom: 32px;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 600;
      }

      .section-icon {
        font-size: 24px;
      }

      .section-stats {
        font-size: 13px;
        color: #86868B;
      }

      .add-type-btn {
        padding: 6px 12px;
        background: #F5F5F7;
        border: 1px solid #D2D2D7;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }

      .add-type-btn:hover {
        background: #E8E8ED;
      }

      .entity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }

      .entity-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #D2D2D7;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .entity-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .entity-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .entity-name {
        font-size: 16px;
        font-weight: 600;
        color: #1D1D1F;
      }

      .entity-menu {
        padding: 4px 8px;
        background: transparent;
        border: none;
        border-radius: 4px;
        font-size: 18px;
        cursor: pointer;
        color: #86868B;
        transition: background 0.15s;
      }

      .entity-menu:hover {
        background: #F5F5F7;
      }

      .entity-identifier {
        font-size: 13px;
        color: #86868B;
        margin-bottom: 12px;
      }

      .entity-stats {
        display: flex;
        gap: 16px;
        padding-top: 12px;
        border-top: 1px solid #F5F5F7;
      }

      .entity-stat {
        display: flex;
        flex-direction: column;
      }

      .stat-value {
        font-size: 18px;
        font-weight: 600;
        color: #0071E3;
      }

      .stat-label {
        font-size: 11px;
        color: #86868B;
        text-transform: uppercase;
      }

      .empty-state {
        text-align: center;
        padding: 48px 32px;
        background: white;
        border-radius: 12px;
        border: 1px dashed #D2D2D7;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .empty-state-text {
        font-size: 14px;
        color: #86868B;
        margin-bottom: 16px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #515154;
        margin-bottom: 8px;
      }

      .form-input, .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #D2D2D7;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
      }

      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #0071E3;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }

      .btn-primary {
        background: #0071E3;
        color: white;
      }

      .btn-primary:hover {
        background: #0077ED;
      }

      .btn-secondary {
        background: #F5F5F7;
        color: #1D1D1F;
      }

      .btn-secondary:hover {
        background: #E8E8ED;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Life Admin</div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">Overview</div>
            <a href="/" class="nav-item">Vault</a>
            <a href="/dashboard" class="nav-item">Dashboard</a>
            <a href="/categories" class="nav-item">Categories</a>
            <a href="/agents" class="nav-item">Agents</a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">Insights</div>
            <a href="/actions" class="nav-item">Actions</a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">Settings</div>
            <a href="/entities-manage" class="nav-item active">Entities</a>
          </div>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="top-bar">
          <h1 class="page-title">Entity Management</h1>
          <button class="add-entity-btn" onclick="openAddModal()">+ Add Entity</button>
        </div>

        <div class="content-area">
          <!-- Introduction -->
          <div class="intro-text">
            <h2>Manage Your Family, Vehicles, Pets & More</h2>
            <p>
              Entities help organize documents and insights by person, vehicle, pet, or property.
              The AI automatically detects who or what each document is about, giving you personalized intelligence.
              Add family members, vehicles, and pets to enable entity-aware document management.
            </p>
          </div>

          <!-- Entity Types -->
          {% for entity_type, type_info in entity_type_info.items() %}
            {% if entity_type in entities_by_type or entity_type in ['person', 'vehicle', 'pet', 'property'] %}
              <div class="entity-type-section">
                <div class="section-header">
                  <div class="section-title">
                    <span class="section-icon">{{ type_info.icon }}</span>
                    <span>{{ type_info.label }}</span>
                    {% if entity_type in type_stats %}
                      <span class="section-stats">
                        ({{ type_stats[entity_type].count }} {{ 'entity' if type_stats[entity_type].count == 1 else 'entities' }},
                        {{ type_stats[entity_type].total_docs }} documents)
                      </span>
                    {% endif %}
                  </div>
                  <button class="add-type-btn" onclick="openAddModal('{{ entity_type }}')">
                    + Add {{ type_info.label.rstrip('s') }}
                  </button>
                </div>

                {% if entity_type in entities_by_type %}
                  <div class="entity-grid">
                    {% for entity in entities_by_type[entity_type] %}
                      <div class="entity-card">
                        <div class="entity-card-header">
                          <div class="entity-name">{{ entity.name }}</div>
                          <button class="entity-menu" onclick="alert('Edit/Delete coming soon')">‚ãØ</button>
                        </div>
                        {% if entity.identifier %}
                          <div class="entity-identifier">{{ entity.identifier }}</div>
                        {% endif %}
                        <div class="entity-stats">
                          <div class="entity-stat">
                            <div class="stat-value">{{ entity.document_count }}</div>
                            <div class="stat-label">Documents</div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty-state">
                    <div class="empty-state-icon">{{ type_info.icon }}</div>
                    <div class="empty-state-text">
                      No {{ type_info.label.lower() }} added yet
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal('{{ entity_type }}')">
                      + Add {{ type_info.label.rstrip('s') }}
                    </button>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Add Entity Modal -->
    <div id="addModal" class="modal">
      <div class="modal-content">
        <h2 class="modal-header">Add New Entity</h2>
        <form id="addEntityForm" onsubmit="handleAddEntity(event)">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select id="entityType" class="form-select" required>
              <option value="person">üë§ Person</option>
              <option value="vehicle">üöó Vehicle</option>
              <option value="pet">üêæ Pet</option>
              <option value="property">üè† Property</option>
              <option value="business">üíº Business</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" id="entityName" class="form-input" required placeholder="e.g., Stephen, Toyota Corolla, Buddy">
          </div>
          <div class="form-group">
            <label class="form-label">Identifier (Optional)</label>
            <input type="text" id="entityIdentifier" class="form-input" placeholder="e.g., email, registration, address">
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Entity</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function openAddModal(entityType) {
        const modal = document.getElementById('addModal');
        const typeSelect = document.getElementById('entityType');

        if (entityType) {
          typeSelect.value = entityType;
        }

        modal.classList.add('active');
      }

      function closeAddModal() {
        const modal = document.getElementById('addModal');
        modal.classList.remove('active');
        document.getElementById('addEntityForm').reset();
      }

      async function handleAddEntity(event) {
        event.preventDefault();

        const entityType = document.getElementById('entityType').value;
        const entityName = document.getElementById('entityName').value;
        const entityIdentifier = document.getElementById('entityIdentifier').value;

        try {
          const params = new URLSearchParams({
            entity_type: entityType,
            entity_name: entityName,
          });

          if (entityIdentifier) {
            params.append('entity_identifier', entityIdentifier);
          }

          const response = await fetch('/entities?' + params.toString(), {
            method: 'POST',
          });

          if (response.ok) {
            // Reload page to show new entity
            window.location.reload();
          } else {
            alert('Failed to create entity');
          }
        } catch (error) {
          console.error('Error creating entity:', error);
          alert('Failed to create entity');
        }
      }

      // Close modal on background click
      document.getElementById('addModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeAddModal();
        }
      });
    </script>
  </body>
</html>
